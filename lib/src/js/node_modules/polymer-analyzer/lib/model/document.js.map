{"version":3,"sources":["model/document.ts"],"names":[],"mappings":"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","file":"document.js","sourcesContent":["/**\n * @license\n * Copyright (c) 2016 The Polymer Project Authors. All rights reserved.\n * This code may only be used under the BSD style license found at\n * http://polymer.github.io/LICENSE.txt\n * The complete set of authors may be found at\n * http://polymer.github.io/AUTHORS.txt\n * The complete set of contributors may be found at\n * http://polymer.github.io/CONTRIBUTORS.txt\n * Code distributed by Google as part of the polymer project is also\n * subject to an additional IP rights grant found at\n * http://polymer.github.io/PATENTS.txt\n */\n\nimport {Analyzer} from '../analyzer';\nimport {ParsedDocument} from '../parser/document';\nimport {Behavior} from '../polymer/behavior';\nimport {DomModule} from '../polymer/dom-module-scanner';\nimport {PolymerElement} from '../polymer/polymer-element';\nimport {Warning} from '../warning/warning';\n\nimport {Element} from './element';\nimport {ElementReference} from './element-reference';\nimport {Feature, ScannedFeature} from './feature';\nimport {Import} from './import';\nimport {isResolvable} from './resolvable';\nimport {SourceRange} from './source-range';\n\n/**\n * The metadata for all features and elements defined in one document\n */\nexport class ScannedDocument {\n  document: ParsedDocument<any, any>;\n  features: ScannedFeature[];\n  isInline = false;\n  sourceRange: SourceRange|undefined = undefined;  // TODO(rictic): track this\n  warnings: Warning[];\n\n  constructor(\n      document: ParsedDocument<any, any>, features: ScannedFeature[],\n      warnings?: Warning[]) {\n    this.document = document;\n    this.features = features;\n    this.warnings = warnings || [];\n    this.isInline = document.isInline;\n  }\n\n  get url() {\n    return this.document.url;\n  }\n}\n\nexport class Document implements Feature {\n  kinds: Set<string> = new Set(['document']);\n  identifiers: Set<string> = new Set();\n  analyzer: Analyzer;\n  warnings: Warning[];\n\n  private _localFeatures = new Set<Feature>();\n  private _scannedDocument: ScannedDocument;\n\n  /** See parsedDocument. */\n  astNode: null = null;\n\n  /**\n   * To handle recursive dependency graphs we must track whether we've started\n   * resolving this Document so that we can reliably early exit even if one\n   * of our dependencies tries to resolve this document.\n   */\n  private _begunResolving = false;\n\n  /**\n   * True after this document and all of its children are finished resolving.\n   */\n  private _doneResolving = false;\n\n  constructor(base: ScannedDocument, analyzer: Analyzer) {\n    if (base == null) {\n      throw new Error('base is null');\n    }\n    if (analyzer == null) {\n      throw new Error('analyzer is null');\n    }\n    this._scannedDocument = base;\n    this.analyzer = analyzer;\n\n    if (!base.isInline) {\n      this.identifiers.add(this.url);\n    }\n    this.kinds.add(`${this.parsedDocument.type}-document`);\n    this.warnings = Array.from(base.warnings);\n  }\n\n  get url(): string {\n    return this._scannedDocument.url;\n  }\n\n  get isInline(): boolean {\n    return this._scannedDocument.isInline;\n  }\n\n  get parsedDocument(): ParsedDocument<any, any> {\n    return this._scannedDocument.document;\n  }\n\n  get sourceRange(): SourceRange|undefined {\n    return this._scannedDocument.sourceRange;\n  }\n\n  get resolved(): boolean {\n    return this._doneResolving;\n  }\n\n  get type(): string {\n    return this.parsedDocument.type;\n  }\n\n  /**\n   * Resolves all features of this document, so that they have references to all\n   * their dependencies.\n   *\n   * This method can only be called once\n   */\n  // TODO(justinfagnani): move to ScannedDocument\n  resolve() {\n    if (this._doneResolving) {\n      throw new Error('resolve can only be called once');\n    }\n    if (this._begunResolving) {\n      return;\n    }\n    this._begunResolving = true;\n    this._addFeature(this);\n    for (const scannedFeature of this._scannedDocument.features) {\n      if (isResolvable(scannedFeature)) {\n        const feature = scannedFeature.resolve(this);\n        if (feature) {\n          this._addFeature(feature);\n        }\n      }\n    }\n    this._doneResolving = true;\n  }\n\n  /**\n   * Adds and indexes a feature to this documentled before resolve().\n   */\n  _addFeature(feature: Feature) {\n    if (this._doneResolving) {\n      throw new Error('_addFeature can not be called after _resolve()');\n    }\n    this._indexFeature(feature);\n    this._localFeatures.add(feature);\n  }\n\n  getByKind(kind: 'element'): Set<Element>;\n  getByKind(kind: 'polymer-element'): Set<PolymerElement>;\n  getByKind(kind: 'behavior'): Set<Behavior>;\n  getByKind(kind: 'dom-module'): Set<DomModule>;\n  getByKind(kind: 'document'): Set<Document>;\n  getByKind(kind: 'import'): Set<Import>;\n  getByKind(kind: 'element-reference'): Set<ElementReference>;\n  getByKind(kind: string): Set<Feature>;\n  getByKind(kind: string): Set<Feature> {\n    if (this._featuresByKind) {\n      // We have a fast index! Use that.\n      return this._featuresByKind.get(kind) || new Set();\n    } else if (this._doneResolving) {\n      // We're done discovering features in this document and its children so\n      // we can safely build up the indexes.\n      this._buildIndexes();\n      return this.getByKind(kind);\n    }\n    return this._getByKind(kind, new Set());\n  }\n\n  getById(kind: 'element', tagName: string): Set<Element>;\n  getById(kind: 'polymer-element', tagName: string): Set<Document>;\n  getById(kind: 'behavior', className: string): Set<Behavior>;\n  getById(kind: 'dom-module', idAttr: string): Set<DomModule>;\n  getById(kind: 'document', url: string): Set<Document>;\n  getById(kind: 'element-reference', tagName: string): Set<ElementReference>;\n  getById(kind: string, identifier: string): Set<Feature>;\n  getById(kind: string, identifier: string): Set<Feature> {\n    if (this._featuresByKindAndId) {\n      // We have a fast index! Use that.\n      const idMap = this._featuresByKindAndId.get(kind);\n      return (idMap && idMap.get(identifier)) || new Set();\n    } else if (this._doneResolving) {\n      // We're done discovering features in this document and its children so\n      // we can safely build up the indexes.\n      this._buildIndexes();\n      return this.getById(kind, identifier);\n    }\n    const result = new Set<Feature>();\n    for (const featureOfKind of this.getByKind(kind)) {\n      if (featureOfKind.identifiers.has(identifier)) {\n        result.add(featureOfKind);\n      }\n    }\n    return result;\n  }\n\n  getOnlyAtId(kind: 'element', tagName: string): Element|undefined;\n  getOnlyAtId(kind: 'polymer-element', tagName: string): PolymerElement\n      |undefined;\n  getOnlyAtId(kind: 'behavior', className: string): Behavior|undefined;\n  getOnlyAtId(kind: 'dom-module', idAttr: string): DomModule|undefined;\n  getOnlyAtId(kind: 'document', url: string): Document|undefined;\n  getOnlyAtId(kind: 'element-reference', tagName: string): ElementReference;\n  getOnlyAtId(kind: string, identifier: string): Feature|undefined;\n  getOnlyAtId(kind: string, identifier: string): Feature|undefined {\n    const results = this.getById(kind, identifier);\n    if (results.size > 1) {\n      throw new Error(\n          `Expected to find at most one ${kind} with id ${identifier} ` +\n          `but found ${results.size}.`);\n    }\n    return results.values().next().value || undefined;\n  }\n\n  private _getByKind(kind: string, documentsWalked: Set<Document>):\n      Set<Feature> {\n    const result = new Set<Feature>();\n    documentsWalked.add(this);\n\n    for (const feature of this._localFeatures) {\n      if (feature.kinds.has(kind)) {\n        result.add(feature);\n      }\n      if (feature.kinds.has('import')) {\n        const document = (feature as Import).document;\n        if (!documentsWalked.has(document)) {\n          for (const subFeature of document._getByKind(kind, documentsWalked)) {\n            result.add(subFeature);\n          }\n        }\n      }\n      if (feature.kinds.has('document')) {\n        const document = (feature as Document);\n        if (!documentsWalked.has(document)) {\n          for (const subFeature of document._getByKind(kind, documentsWalked)) {\n            result.add(subFeature);\n          }\n        }\n      }\n    }\n\n    return result;\n  }\n\n  /**\n   * Get features for all documents reachable via imports in this document.\n   * If `deep` is false, only return features in this document.\n   */\n  getFeatures(deep?: boolean): Set<Feature> {\n    if (deep == null) {\n      deep = true;\n    }\n    const result = new Set<Feature>();\n    this._getFeatures(result, new Set<Document>(), deep);\n    return result;\n  }\n\n  private _getFeatures(\n      result: Set<Feature>, visited: Set<Document>, deep: boolean) {\n    if (visited.has(this)) {\n      return;\n    }\n    visited.add(this);\n    for (const feature of this._localFeatures) {\n      result.add(feature);\n      if (deep) {\n        if (feature.kinds.has('document')) {\n          (feature as Document)._getFeatures(result, visited, deep);\n        }\n        if (feature.kinds.has('import')) {\n          (feature as Import).document._getFeatures(result, visited, deep);\n        }\n      }\n    }\n  }\n\n  /**\n   * Get warnings for this document and all local features of this document. If\n   * `deep` is true, return warnings for all documents and features reachable\n   * via imports in this document.\n   */\n  getWarnings(deep?: boolean): Warning[] {\n    const warnings: Set<Warning> = new Set(this.warnings);\n    if (deep == null) {\n      deep = false;\n    }\n    for (const feature of this.getFeatures(deep)) {\n      for (const warning of feature.warnings) {\n        warnings.add(warning);\n      }\n    }\n    return Array.from(warnings);\n  }\n\n  toString(): string {\n    return this._toString(new Set()).join('\\n');\n  }\n\n  private _toString(documentsWalked: Set<Document>) {\n    let result =\n        [`<Document type=${this.parsedDocument.type} url=${this.url}>\\n`];\n    if (documentsWalked.has(this)) {\n      return result;\n    }\n    documentsWalked.add(this);\n\n    for (const localFeature of this._localFeatures) {\n      if (localFeature instanceof Document) {\n        result = result.concat(\n            localFeature._toString(documentsWalked).map(line => `  ${line}`));\n      } else {\n        let subResult = localFeature.toString();\n        if (subResult === '[object Object]') {\n          subResult =\n              `<${localFeature.constructor.name} kinds=\"${Array\n                  .from(localFeature.kinds)\n                  .join(', ')}\" ids=\"${Array.from(localFeature.identifiers)\n                  .join(',')}\">}`;\n        }\n        result.push(`  ${subResult}`);\n      }\n    }\n\n    return result;\n  }\n\n  stringify(): string {\n    const inlineDocuments =\n        (Array.from(this._localFeatures)\n             .filter(f => f instanceof Document && f.isInline) as Document[])\n            .map(d => d.parsedDocument);\n    return this.parsedDocument.stringify({inlineDocuments: inlineDocuments});\n  }\n\n  private _featuresByKind: Map<string, Set<Feature>>|null = null;\n  private _featuresByKindAndId: Map<string, Map<string, Set<Feature>>>|null =\n      null;\n  private _initIndexes() {\n    this._featuresByKind = new Map<string, Set<Feature>>();\n    this._featuresByKindAndId = new Map<string, Map<string, Set<Feature>>>();\n  }\n\n  private _indexFeature(feature: Feature) {\n    if (!this._featuresByKind || !this._featuresByKindAndId) {\n      return;\n    }\n    for (const kind of feature.kinds) {\n      const kindSet = this._featuresByKind.get(kind) || new Set<Feature>();\n      kindSet.add(feature);\n      this._featuresByKind.set(kind, kindSet);\n      for (const id of feature.identifiers) {\n        const identifiersMap = this._featuresByKindAndId.get(kind) ||\n            new Map<string, Set<Feature>>();\n        this._featuresByKindAndId.set(kind, identifiersMap);\n        const idSet = identifiersMap.get(id) || new Set<Feature>();\n        identifiersMap.set(id, idSet);\n        idSet.add(feature);\n      }\n    }\n  }\n\n  private _buildIndexes() {\n    if (this._featuresByKind) {\n      throw new Error(\n          'Tried to build indexes multiple times. This should never happen.');\n    }\n    if (!this._doneResolving) {\n      throw new Error(\n          `Tried to build indexes before finished resolving. ` +\n          `Need to wait until afterwards or the indexes would be incomplete.`);\n    }\n    this._initIndexes();\n    for (const feature of this.getFeatures()) {\n      this._indexFeature(feature);\n    }\n  }\n}\n"]}